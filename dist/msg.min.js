/* Msg 2014-11-20 */
(function(t,n){function r(t){return function(n){return h.call(n)==="[object "+t+"]"}}function e(t,n){return null!=t&&d.call(t,n)}function i(t){if(!g(t))return[];if(Object.keys)return Object.keys(t);var n=[];for(var r in t)e(t,r)&&n.push(r);return n}function s(t){for(var n=i(t),r=n.length,e=Array(r),s=0;r>s;s+=1)e[s]=t[n[s]];return e}function u(n,r,i){var s=n.length;if(s===+s&&s){for(var u=0;s>u;u+=1)if(r.call(i||t,n[u],u,n)===!1)return n;return n}for(var o in n)if(e(n,o)&&r.call(i||t,n[o],o,n)===!1)return n;return n}function o(){var t,n=arguments[0];if("boolean"==typeof n&&(t=n,n=arguments[1]),!g(n))return n;var r=y.call(arguments,t?2:1);return u(r,function(r){g(r)&&u(r,function(r,e){if(t&&g(r)){var i=n[e];return n[e]=g(i)?i:{},o(t,n[e],r)}n[e]=r})}),n}function a(t){throw Error(t)}function c(){return"Msg-"+Math.random().toString(36).substr(2)}function f(){return this instanceof f?(this._reactions={},n):new f}var l=Object.prototype,p=Array.prototype,h=l.toString,d=l.hasOwnProperty,y=p.slice;p.push;var g=r("Object"),v=r("String"),_=r("Function"),m=Array.isArray||r("Array"),b="undefined"!=typeof process&&process.nextTick||function(t){return setTimeout(t,0)},x=f.prototype={_add:function(t,n){var r,e=t.indexOf(".");return 0>=e?r=c():(r=t.substr(e+1),t=t.substr(0,e)),reactions=this._reactions[t]=this._reactions[t]||{},reactions[r]=reactions[r]||[],reactions[r].push(n),this},on:function(t,n){if(_(n)||a(n+"不是一个函数"),v(t))this._add(t,n);else if(m(t)){var r=this;u(t,function(t){v(t)&&r._add(t,n)})}return this},_react:function(r){function i(e,i){(s===n||s===i)&&u(e,function(n){n.msgType=r,n.apply(t,o)})}if(v(r)&&e(this._reactions,r)){var s,o=y.call(arguments,1),a=r.indexOf(".");0===a?(s=r.substr(1),u(this._reactions,function(t,n){r=n,u(t,i)})):(a>0&&(s=r.substr(a+1),r=r.substr(0,a)),u(this._reactions[r],i))}return this},spread:function(t){var n=this,r=y.call(arguments);return t?v(t)?this._react.apply(n,r):m(t)&&(r=r.slice(1),u(t,function(t){n._react.apply(n,[t].concat(r))})):(r=r.slice(1),u(i(this._reactions),function(t){n._react.apply(n,[t].concat(r))})),this},off:function(t){function n(t){var n,e=t.indexOf(".");0===e?t in r._reactions?r._reactions[t]={}:(n=t.substr(1),u(r._reactions,function(t){u(t,function(r,e){n===e&&(t[n]=[])})})):e>0?(n=t.substr(e+1),t=t.substr(0,e),r._reactions[t][n]=[]):r._reactions[t]={}}var r=this;return t?m(t)?u(t,n):v(t)&&n(t):this._reactions={},this}};o(x,{once:function(n,r){function e(){r.apply(t,arguments),i.off(n,e)}var i=this;return n+=".once",this._add(n,e)},hold:function(n,r,e){function i(){0>=--r&&e.apply(t,arguments)}return r===+r&&r>=0||a(r+"不是一个正整数"),this._add(n,i),i},tie:function(n,r){function i(){if(e(c,i.msgType)&&(delete c[i.msgType],f[i.msgType]=1===arguments.length?arguments[0]:y.call(arguments),++o>=s)){var a=[];u(n,function(t){v(t)&&(t=t.substr(0,t.indexOf(".")),c[t]=1,a.push(f[t]))}),r.apply(t,a)}}if(_(r)||a(r+"不是一个函数"),m(n)){var s=0,o=0,c={},f={};u(n,function(t){v(t)&&(t=t.substr(0,t.indexOf(".")),c[t]=f[t]=1,s+=1)}),this.on(n,i)}else v(n)&&this._add(n,r);return this},tick:function(){var t=y.call(arguments),n=this;return b(function(){n.spread.apply(n,t)}),this},delay:function(t){var n=y.call(arguments,1),r=this;return setTimeout(function(){r.spread.apply(r,n)},t||0),this}}),o(x,{isObj:g,isFn:_,isStr:v,isArr:m,keys:i,has:e,values:s,each:u,extend:o,nextTick:b}),"function"==typeof define?define(function(){return f}):"undefined"!=typeof module&&g(module.exports)&&g(exports)?module.exports=f:t.Msg=f})(this);